<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SR-2555 Trainer</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 20px;
}

.container {
    max-width: 800px;
    margin: auto;
}

.header {
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.section {
    margin-top: 25px;
}

.section-title {
    font-weight: bold;
    margin-bottom: 8px;
}

.phrase {
    background: white;
    padding: 6px 10px;
    border-radius: 6px;
    margin-bottom: 6px;
}

.phrase-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.phrase-number {
    color: #888;
    min-width: 30px;
}

.translation {
    display: none;
    margin-top: 5px;
    padding-left: 40px;
    font-size: 14px;
    color: #1a73e8;
}

.examples {
    display: none;
    margin-top: 5px;
    padding-left: 40px;
    font-size: 14px;
    color: #7b1fa2;
}

.status {
    margin-top: 10px;
    color: #666;
}

.section-title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
}

.flip-btn {
    border: 1px solid #ddd;
    background: #fff;
    border-radius: 6px;
    padding: 2px 8px;
    cursor: pointer;
}

.flip-btn:hover {
    background: #f3f3f3;
}

.phrase-main {
    flex: 1;
}


.section-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.section-check {
    width: 16px;
    height: 16px;
    cursor: pointer;
}

.collapse-btn {
    border: 1px solid #ddd;
    background: #fff;
    border-radius: 6px;
    padding: 2px 8px;
    cursor: pointer;
    line-height: 1;
}

.collapse-btn:hover {
    background: #f3f3f3;
}

.section.done .section-title {
    opacity: 0.6;
}

</style>

</head>
<body>

<div class="container">

<div class="header">
<h1>SR-2555 Trainer</h1>

Day:
<input type="number" id="dayInput" value="1" min="1">
<button onclick="loadDay()">Load</button>

<div class="status" id="status">Loading database...</div>

</div>

<div id="content"></div>

</div>

<script>

const NEW_PER_DAY = 7;
const INTERVALS = [180,90,30,14,7,3,1];
const ASC_INTERVALS = [...INTERVALS].reverse();

let phrases = [];

async function loadCSV() {

    try {

        const response = await fetch("database_Phrases.csv");
        const text = await response.text();

        parseCSV(text);

        document.getElementById("status").innerText =
            "Loaded: " + phrases.length + " phrases";

        loadDay();

    } catch(e) {

        document.getElementById("status").innerText =
            "Error loading database_Phrases.csv";

    }

}

function parseCSV(text) {

    phrases = [];

    const lines = text.split(/\r?\n/);

    for (let i = 1; i < lines.length; i++) {

        if (!lines[i].trim()) continue;

        const parts = lines[i].split(";");

        phrases.push({
            id: parseInt(parts[0]),
            en: parts[1] || "",
            sk: parts[2] || "",
            ex1: parts[3] || "",
            ex2: parts[4] || "",
            ex3: parts[5] || ""
        });
    }
}

function getBlock(day) {

    const start = (day - 1) * NEW_PER_DAY + 1;
    const end = day * NEW_PER_DAY;

    return phrases.filter(p => p.id >= start && p.id <= end);
}

function toggle(button, cls) {

    const el = button.closest(".phrase").querySelector("." + cls);

    el.style.display =
        el.style.display === "block" ? "none" : "block";

}

function escapeHtml(str) {
    return (str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function reviewCountForInterval(interval) {
    const idx = ASC_INTERVALS.indexOf(interval);
    return idx === -1 ? "" : (idx + 1) + "x";
}

function applySectionLanguage(sectionEl, flipped) {

    const phrasesEls = sectionEl.querySelectorAll(".phrase");

    phrasesEls.forEach(ph => {

        const main = ph.querySelector(".phrase-main");
        const tr = ph.querySelector(".translation");
        const trBtn = ph.querySelector(".translation-btn");

        if (!main || !tr || !trBtn) return;

        if (flipped) {

            main.innerHTML = main.getAttribute("data-sk") || "";
            tr.innerHTML = tr.getAttribute("data-en") || "";
            trBtn.innerText = "EN";

        } else {

            main.innerHTML = main.getAttribute("data-en") || "";
            tr.innerHTML = tr.getAttribute("data-sk") || "";
            trBtn.innerText = "SK";

        }

    });

}

function flipSection(btn) {

    const sectionEl = btn.closest(".section");

    if (!sectionEl) return;

    const flipped = sectionEl.getAttribute("data-flipped") === "1";

    sectionEl.setAttribute("data-flipped", flipped ? "0" : "1");

    applySectionLanguage(sectionEl, !flipped);

}

function applyDoneState(sectionEl) {

    const key = sectionEl.getAttribute("data-key");

    if (!key) return;

    const val = localStorage.getItem("sr2555_done_" + key);

    const checked = val === "1";

    const cb = sectionEl.querySelector(".section-check");

    if (cb) cb.checked = checked;

    sectionEl.classList.toggle("done", checked);

}

function applyCollapseState(sectionEl, collapsed) {

    const btn = sectionEl.querySelector(".collapse-btn");

    if (btn) btn.innerText = collapsed ? "▶" : "▼";

    const items = sectionEl.querySelectorAll(".phrase");

    items.forEach(it => {

        it.style.display = collapsed ? "none" : "";

    });

}

function toggleDone(cb) {

    const sectionEl = cb.closest(".section");

    if (!sectionEl) return;

    const key = sectionEl.getAttribute("data-key");

    if (!key) return;

    localStorage.setItem("sr2555_done_" + key, cb.checked ? "1" : "0");

    sectionEl.classList.toggle("done", cb.checked);

}

function toggleCollapse(btn) {

    const sectionEl = btn.closest(".section");

    if (!sectionEl) return;

    const key = sectionEl.getAttribute("data-key");

    if (!key) return;

    const collapsed = sectionEl.getAttribute("data-collapsed") === "1";

    sectionEl.setAttribute("data-collapsed", collapsed ? "0" : "1");

    localStorage.setItem("sr2555_collapsed_" + key, collapsed ? "0" : "1");

    applyCollapseState(sectionEl, !collapsed);

}



function createPhraseElement(p) {

    const div = document.createElement("div");

    div.className = "phrase";

    div.innerHTML = `
        <div class="phrase-row">
            <div class="phrase-number">${p.id}</div>
            <div class="phrase-main" data-en="${escapeHtml(p.en)}" data-sk="${escapeHtml(p.sk)}">${p.en}</div>
            <button class="translation-btn" onclick="toggle(this,'translation')">SK</button>
            <button onclick="toggle(this,'examples')">Examples</button>
        </div>
        <div class="translation" data-en="${escapeHtml(p.en)}" data-sk="${escapeHtml(p.sk)}">${p.sk}</div>
        <div class="examples">
            ${p.ex1 ? "<div>"+p.ex1+"</div>" : ""}
            ${p.ex2 ? "<div>"+p.ex2+"</div>" : ""}
            ${p.ex3 ? "<div>"+p.ex3+"</div>" : ""}
        </div>
    `;

    return div;
}

function loadDay() {

    if (!phrases.length) return;

    const day = parseInt(dayInput.value);

    content.innerHTML = "";

    INTERVALS.forEach(interval => {

        const review = getBlock(day - interval);

        if (!review.length) return;

        const sec = document.createElement("div");
        sec.className = "section";
        sec.innerHTML = "<div class='section-title'><div class='section-title-row'><div>REVIEW ("+interval+"–"+reviewCountForInterval(interval)+")</div><button class='flip-btn' onclick='flipSection(this)' title='Flip language for this block'>⇄</button></div></div>";
        sec.setAttribute("data-flipped","0");
        sec.setAttribute("data-key","day-"+day+"-review-"+interval);
        sec.setAttribute("data-collapsed", localStorage.getItem("sr2555_collapsed_" + sec.getAttribute("data-key")) === "1" ? "1" : "0");

        review.forEach(p => sec.appendChild(createPhraseElement(p)));

        applySectionLanguage(sec, false);
        applyDoneState(sec);
        applyCollapseState(sec, sec.getAttribute("data-collapsed") === "1");

        content.appendChild(sec);

    });

    const newBlock = getBlock(day);

    const sec = document.createElement("div");
    sec.className = "section";
    sec.innerHTML = "<div class='section-title'><div class='section-title-row'><div>NEW</div><button class='flip-btn' onclick='flipSection(this)' title='Flip language for this block'>⇄</button></div></div>";
    sec.setAttribute("data-flipped","0");
        sec.setAttribute("data-key","day-"+day+"-review-"+interval);
        sec.setAttribute("data-collapsed", localStorage.getItem("sr2555_collapsed_" + sec.getAttribute("data-key")) === "1" ? "1" : "0");

    newBlock.forEach(p => sec.appendChild(createPhraseElement(p)));

    applySectionLanguage(sec, false);
    applyDoneState(sec);
    applyCollapseState(sec, sec.getAttribute("data-collapsed") === "1");

    content.appendChild(sec);
}

loadCSV();

</script>

</body>
</html>
